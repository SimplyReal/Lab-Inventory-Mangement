<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory</title>
    <style>
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
        }
        .card-header {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .card-body {
            display: flex;
            flex-direction: column;
        }
        .card-actions {
            margin-top: 10px;
        }
        button {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="card-container" id="fact-body"></div>
    <button id="add-item-btn">Add Item</button>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            fetchInventoryItems();
        });

        function fetchInventoryItems() {
            fetch('https://tinkerquest.onrender.com/dashboard/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Fetched data:', data);
                    populateCards(data);
                })
                .catch(error => {
                    console.error('Error fetching inventory items:', error);
                });
        }

        function populateCards(inventoryItems) {
            var cardContainer = document.getElementById("fact-body");
            cardContainer.innerHTML = ""; // Clear existing cards

            inventoryItems.forEach(function(item) {
                var card = document.createElement("div");
                card.className = "card";

                var cardHeader = document.createElement("div");
                cardHeader.className = "card-header";
                cardHeader.textContent = item.name;
                card.appendChild(cardHeader);

                var cardBody = document.createElement("div");
                cardBody.className = "card-body";
                cardBody.innerHTML = `
                    <div>Quantity: <span id="quantity-${item.id}">${item.quantity}</span></div>
                    <div>Threshold: ${item.threshold}</div>
                    <div>Location: ${item.location}</div>
                `;
                card.appendChild(cardBody);

                var cardActions = document.createElement("div");
                cardActions.className = "card-actions";
                cardActions.innerHTML = `
                    <button class="add-btn" data-id="${item.id}">Add</button>
                    <button class="use-btn" data-id="${item.id}">Use</button>
                    <button class="edit-btn" data-id="${item.id}">Edit</button>
                    <button class="delete-btn" data-id="${item.id}">Delete</button>
                `;
                card.appendChild(cardActions);

                cardContainer.appendChild(card);
            });

            // Add event listeners to the newly created buttons
            document.querySelectorAll(".add-btn").forEach(button => {
                button.addEventListener("click", () => {
                    var itemId = button.getAttribute("data-id");
                    incrementQuantity(itemId);
                });
            });

            document.querySelectorAll(".use-btn").forEach(button => {
                button.addEventListener("click", () => {
                    var itemId = button.getAttribute("data-id");
                    decrementQuantity(itemId);
                });
            });

            document.querySelectorAll(".edit-btn").forEach(button => {
                button.addEventListener("click", () => {
                    var itemId = button.getAttribute("data-id");
                    editItem(itemId);
                });
            });

            document.querySelectorAll(".delete-btn").forEach(button => {
                button.addEventListener("click", () => {
                    var itemId = button.getAttribute("data-id");
                    deleteItem(itemId);
                });
            });

            // Add event listeners to item names to fetch description
            document.querySelectorAll(".card-header").forEach(itemName => {
                itemName.addEventListener("click", () => {
                    var itemId = itemName.nextElementSibling.querySelector("button").getAttribute("data-id");
                    fetchItemDescription(itemId);
                });
            });
        }

        function fetchItemDescription(itemId) {
            fetch(`https://tinkerquest.onrender.com/dashboard/${itemId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Fetched description:', data.description);
                    alert(`Description: ${data.description}`);
                })
                .catch(error => {
                    console.error('Error fetching description:', error);
                });
        }

        function incrementQuantity(itemId) {
            var quantityElement = document.getElementById(`quantity-${itemId}`);
            var currentQuantity = parseInt(quantityElement.textContent);
            currentQuantity += 1;
            quantityElement.textContent = currentQuantity;

            updateQuantity(`https://tinkerquest.onrender.com/edit-item/${itemId}/`, currentQuantity);
        }

        function decrementQuantity(itemId) {
            var quantityElement = document.getElementById(`quantity-${itemId}`);
            var currentQuantity = parseInt(quantityElement.textContent);
            //var threshold = parseInt(quantityElement.parentElement.querySelector(".card-body > div:nth-child(2)").textContent);
            if (currentQuantity > 0) {
                currentQuantity -= 1;
                quantityElement.textContent = currentQuantity;

                // if (currentQuantity < threshold) {
                //     alert(`Alert: ${quantityElement.parentElement.querySelector(".card-header").textContent} inventory needs refilling.`);
                // }

                updateQuantity(`https://tinkerquest.onrender.com/edit-item/${itemId}/`, currentQuantity);
            } else {
                console.log("Quantity cannot be negative.");
            }
        }

        function updateQuantity(apiUrl, newQuantity) {
            const options = {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    quantity: newQuantity // Update quantity in the API
                }),
            };

            fetch(apiUrl, options)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Quantity updated successfully:', data);
            })
            .catch(error => {
                console.error('Error updating quantity:', error);
            });
        }

        function editItem(itemId) {
            var attribute = prompt("Enter the attribute to edit (Name, Quantity, Threshold, Location):");
            if (attribute) {
                var newValue = prompt("Enter the new value:");
                if (newValue) {
                    updateAttribute(`https://tinkerquest.onrender.com/edit-item/${itemId}/`, attribute, newValue);
                }
            }
        }

        function updateAttribute(apiUrl, attribute, newValue) {
            const options = {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    [attribute.toLowerCase()]: newValue // Update the specified attribute in the API
                }),
            };

            fetch(apiUrl, options)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log(`${attribute} updated successfully:`, data);
                fetchInventoryItems(); // Refresh the cards after updating item
            })
            .catch(error => {
                console.error(`Error updating ${attribute}:`, error);
            });
        }

        function deleteItem(itemId) {
            var confirmation = confirm("Are you sure you want to delete item with ID: " + itemId);
            if (confirmation) {
                fetch(`https://tinkerquest.onrender.com/delete-item/${itemId}/`, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    // Check if the response is not empty
                    if (response.status === 204) {
                        // No content in response, deletion successful
                        console.log('Item deleted successfully');
                        // Remove the card from the container
                        document.getElementById("fact-body").querySelector(`[data-id="${itemId}"]`).remove();
                    } else {
                        // Parse the response as JSON
                        return response.json();
                    }
                })
                .then(data => {
                    // Handle response data if present
                    if (data) {
                        console.log('Error deleting item:', data);
                    }
                })
                .catch(error => {
                    console.error('Error deleting item:', error);
                });
            }
        }

        document.getElementById("add-item-btn").addEventListener("click", function() {
            var itemName = prompt("Enter the name of the item:");
            if (itemName) {
                // Generate a unique ID (here I'm just using a timestamp)
                var itemId = Date.now().toString();
                fetch('https://tinkerquest.onrender.com/add-item/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: itemId,
                        name: itemName,
                    }),
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Item added successfully:', data);
                    fetchInventoryItems(); // Refresh the cards after adding item
                })
                .catch(error => {
                    console.error('Error adding item:', error);
                });
            }
        });

        function isUniqueId(itemId) {
            var cards = document.querySelectorAll(".card");
            for (var i = 0; i < cards.length; i++) {
                var cardId = cards[i].querySelector(".card-header").getAttribute("data-id");
                if (cardId === itemId) {
                    return false;
                }
            }
            return true;
        }
    </script>
</body>
</html>





