<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventory</title>
    <link rel="stylesheet" href="inventory.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Medicas</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="main.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="inventory.html"
                >Inventory</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Stocks</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="login.html">Signup/Login</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <button id="add-item-btn" class="btn btn-primary">+ Add Item</button>
      <div class="row" id="fact-body"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        fetchInventoryItems();
      });

      function fetchInventoryItems() {
        fetch("https://tinkerquest.onrender.com/dashboard/")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log("Fetched data:", data);
            populateCards(data);
          })
          .catch((error) => {
            console.error("Error fetching inventory items:", error);
          });
      }

      function populateCards(inventoryItems) {
        var cardContainer = document.getElementById("fact-body");
        cardContainer.innerHTML = ""; // Clear existing cards

        inventoryItems.forEach(function (item) {
          var cardCol = document.createElement("div");
          cardCol.className = "col-md-4";

          var card = document.createElement("div");
          card.className = "card mb-4";

          var cardHeader = document.createElement("div");
          cardHeader.className = "card-header";
          cardHeader.textContent = item.name;
          card.appendChild(cardHeader);

          var cardBody = document.createElement("div");
          cardBody.className = "card-body";
          cardBody.innerHTML = `
                    <p class="card-text"><strong>Quantity:</strong> <span id="quantity-${item.id}">${item.quantity}</span></p>
                    <p class="card-text"><strong>Description:</strong> ${item.description}</p>
                    <p class="card-text"><strong>Threshold:</strong> ${item.threshold}</p>
                    <p class="card-text"><strong>Location:</strong> ${item.location}</p>
                `;
          card.appendChild(cardBody);

          var cardActions = document.createElement("div");
          cardActions.className = "card-footer";
          cardActions.innerHTML = `
                    <button class="btn btn-success add-btn" data-id="${item.id}">Add</button>
                    <button class="btn btn-warning use-btn" data-id="${item.id}">Use</button>
                    <button class="btn btn-info edit-btn" data-id="${item.id}">Edit</button>
                    <button class="btn btn-danger delete-btn" data-id="${item.id}">Delete</button>
                `;
          card.appendChild(cardActions);

          cardCol.appendChild(card);
          cardContainer.appendChild(cardCol);
        });

        // Add event listeners to the newly created buttons
        document.querySelectorAll(".add-btn").forEach((button) => {
          button.addEventListener("click", () => {
            var itemId = button.getAttribute("data-id");
            incrementQuantity(itemId);
          });
        });

        document.querySelectorAll(".use-btn").forEach((button) => {
          button.addEventListener("click", () => {
            var itemId = button.getAttribute("data-id");
            decrementQuantity(itemId);
          });
        });

        document.querySelectorAll(".edit-btn").forEach((button) => {
          button.addEventListener("click", () => {
            var itemId = button.getAttribute("data-id");
            editItem(itemId);
          });
        });

        document.querySelectorAll(".delete-btn").forEach((button) => {
          button.addEventListener("click", () => {
            var itemId = button.getAttribute("data-id");
            deleteItem(itemId);
          });
        });

        // Add event listeners to item names to fetch description
        document.querySelectorAll(".card-header").forEach((itemName) => {
          itemName.addEventListener("click", () => {
            var itemId = itemName.nextElementSibling
              .querySelector("button")
              .getAttribute("data-id");
            fetchItemDescription(itemId);
          });
        });
      }

      function fetchItemDescription(itemId) {
        fetch(`https://tinkerquest.onrender.com/dashboard/${itemId}`)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log("Fetched description:", data.description);
            alert(`Description: ${data.description}`);
          })
          .catch((error) => {
            console.error("Error fetching description:", error);
          });
      }

      function incrementQuantity(itemId) {
        var quantityElement = document.getElementById(`quantity-${itemId}`);
        var currentQuantity = parseInt(quantityElement.textContent);
        currentQuantity += 1;
        quantityElement.textContent = currentQuantity;

        updateQuantity(
          `https://tinkerquest.onrender.com/edit-item/${itemId}/`,
          currentQuantity
        );
      }

      function decrementQuantity(itemId) {
        var quantityElement = document.getElementById(`quantity-${itemId}`);
        var currentQuantity = parseInt(quantityElement.textContent);
        //var threshold = parseInt(quantityElement.parentElement.querySelector(".card-body > div:nth-child(2)").textContent);
        if (currentQuantity > 0) {
          currentQuantity -= 1;
          quantityElement.textContent = currentQuantity;

          // if (currentQuantity < threshold) {
          //     alert(`Alert: ${quantityElement.parentElement.querySelector(".card-header").textContent} inventory needs refilling.`);
          // }

          updateQuantity(
            `https://tinkerquest.onrender.com/edit-item/${itemId}/`,
            currentQuantity
          );
        } else {
          console.log("Quantity cannot be negative.");
        }
      }

      function updateQuantity(apiUrl, newQuantity) {
        const options = {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            quantity: newQuantity, // Update quantity in the API
          }),
        };

        fetch(apiUrl, options)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log("Quantity updated successfully:", data);
          })
          .catch((error) => {
            console.error("Error updating quantity:", error);
          });
      }

      function editItem(itemId) {
        var attribute = prompt(
          "Enter the attribute to edit (Name, Quantity, Threshold, Location):"
        );
        if (attribute) {
          var newValue = prompt("Enter the new value:");
          if (newValue) {
            updateAttribute(
              `https://tinkerquest.onrender.com/edit-item/${itemId}/`,
              attribute,
              newValue
            );
          }
        }
      }

      function updateAttribute(apiUrl, attribute, newValue) {
        const options = {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            [attribute.toLowerCase()]: newValue, // Update the specified attribute in the API
          }),
        };

        fetch(apiUrl, options)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log(`${attribute} updated successfully:`, data);
            fetchInventoryItems(); // Refresh the cards after updating item
          })
          .catch((error) => {
            console.error(`Error updating ${attribute}:`, error);
          });
      }

      function deleteItem(itemId) {
        var confirmation = confirm(
          "Are you sure you want to delete item with ID: " + itemId
        );
        if (confirmation) {
          fetch(`https://tinkerquest.onrender.com/delete-item/${itemId}/`, {
            method: "DELETE",
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              // Check if the response is not empty
              if (response.status === 204) {
                // No content in response, deletion successful
                console.log("Item deleted successfully");
                // Remove the card from the container
                document
                  .getElementById("fact-body")
                  .querySelector(`[data-id="${itemId}"]`)
                  .remove();

                fetchInventoryItems();
              } else {
                // Parse the response as JSON
                return response.json();
              }
            })
            .then((data) => {
              // Handle response data if present
              if (data) {
                console.log("Error deleting item:", data);
              }
            })
            .catch((error) => {
              console.error("Error deleting item:", error);
            });
        }
      }

      document
        .getElementById("add-item-btn")
        .addEventListener("click", function () {
          var itemName = prompt("Enter the name of the item:");
          var quantity = prompt("Enter the quantity of the item:");
          var description = prompt("Enter the description of the item:");
          var threshold = prompt("Enter the threshold of the item:");
          var location = prompt("Enter the location of the item:");
          if (itemName) {
            fetch("https://tinkerquest.onrender.com/add-item/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name: itemName,
                quantity: quantity,
                description: description,
                date_created: "2024-03-16T07:38:07.236123+05:30",
                threshold: threshold,
                location: location,
              }),
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error("Network response was not ok");
                }
                return response.json();
              })
              .then((data) => {
                console.log("Item added successfully:", data);
                fetchInventoryItems(); // Refresh the cards after adding item
              })
              .catch((error) => {
                console.error("Error adding item:", error);
              });
          }
        });

      function isUniqueId(itemId) {
        var cards = document.querySelectorAll(".card");
        for (var i = 0; i < cards.length; i++) {
          var cardId = cards[i]
            .querySelector(".card-header")
            .getAttribute("data-id");
          if (cardId === itemId) {
            return false;
          }
        }
        return true;
      }
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
